# Prometheus 告警规则
# 用于监控 VecBoost 服务的健康状态

groups:
  - name: vecboost_alerts
    interval: 30s
    rules:
      # 服务可用性告警
      - alert: VecBoostServiceDown
        expr: up{job="vecboost"} == 0
        for: 1m
        labels:
          severity: critical
          component: availability
        annotations:
          summary: "VecBoost 服务不可用"
          description: "VecBoost 服务在过去 1 分钟内不可用"

      # 高错误率告警
      - alert: HighErrorRate
        expr: rate(vecboost_requests_total{status=~"5.."}[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          component: error_rate
        annotations:
          summary: "错误率过高"
          description: "VecBoost 服务在过去 5 分钟内的错误率超过 5%"

      # 高延迟告警
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(vecboost_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          component: latency
        annotations:
          summary: "P95 延迟过高"
          description: "VecBoost 服务在过去 5 分钟内的 P95 延迟超过 500ms"

      # 内存使用率告警
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="vecboost"} / 4 * 1024 * 1024 * 1024 > 0.8
        for: 5m
        labels:
          severity: warning
          component: memory
        annotations:
          summary: "内存使用率过高"
          description: "VecBoost 服务的内存使用率超过 80%"

      # CPU 使用率告警
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job="vecboost"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: cpu
        annotations:
          summary: "CPU 使用率过高"
          description: "VecBoost 服务的 CPU 使用率超过 80%"

      # QPS 下降告警
      - alert: LowQPS
        expr: rate(vecboost_requests_total[5m]) < 10
        for: 10m
        labels:
          severity: info
          component: throughput
        annotations:
          summary: "QPS 过低"
          description: "VecBoost 服务在过去 10 分钟内的 QPS 低于 10"

      # 内存池使用率告警
      - alert: MemoryPoolHighUsage
        expr: vecboost_memory_pool_usage_bytes / vecboost_memory_pool_capacity_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          component: memory_pool
        annotations:
          summary: "内存池使用率过高"
          description: "内存池使用率超过 90%"

      # 队列积压告警
      - alert: QueueBacklog
        expr: vecboost_queue_size > 100
        for: 5m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "请求队列积压"
          description: "请求队列大小超过 100"

      # GPU 内存使用率告警（如果有 GPU）
      - alert: HighGPUMemoryUsage
        expr: vecboost_gpu_memory_usage_bytes / vecboost_gpu_memory_total_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          component: gpu_memory
        annotations:
          summary: "GPU 内存使用率过高"
          description: "GPU 内存使用率超过 90%"

  - name: vecboost_performance
    interval: 1m
    rules:
      # 性能下降告警
      - alert: PerformanceDegradation
        expr: |
          (
            rate(vecboost_requests_total[5m]) /
            rate(vecboost_requests_total[1h] offset 55m)
          ) < 0.5
        for: 10m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "性能显著下降"
          description: "当前 QPS 相比 1 小时前下降了超过 50%"

      # 缓存命中率低告警
      - alert: LowCacheHitRate
        expr: rate(vecboost_cache_hits_total[5m]) / rate(vecboost_cache_requests_total[5m]) < 0.5
        for: 10m
        labels:
          severity: info
          component: cache
        annotations:
          summary: "缓存命中率低"
          description: "缓存命中率低于 50%"